<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Security and Firewalls - Linux Systems Administration</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Book on entry level Linux systems administration work.">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme -->
        

        

        <!-- Fetch Clipboard.js from CDN but have a local fallback -->
        <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js"></script>
        <script>
            if (typeof Clipboard == 'undefined') {
                document.write(unescape("%3Cscript src='clipboard.min.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch store.js from local - TODO add CDN when 2.x.x is available on cdnjs -->
        <script src="store.js"></script>

    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = store.get('mdbook-theme');
            if (theme === null || theme === undefined) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = store.get('mdbook-sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li><a href="p1-linux-sysadmin.html"><strong>1.</strong> Linux Systems Administration</a></li><li><ul class="section"><li><a href="01-what-is-linux.html"><strong>1.1.</strong> What is Linux?</a></li><li><a href="02-what-is-sysadmin.html"><strong>1.2.</strong> What is Systems Administration?</a></li><li><a href="03-history-linux-unix.html"><strong>1.3.</strong> History of Unix and Linux</a></li></ul></li><li><a href="p2-the-command-line.html"><strong>2.</strong> Learning the Command Line</a></li><li><ul class="section"><li><a href="04-quick-ssh-connect.html"><strong>2.1.</strong> Connect to a Remote Server</a></li><li><a href="05-the-linux-filesystem.html"><strong>2.2.</strong> The Linux Filesystem</a></li><li><a href="06-files-and-directories.html"><strong>2.3.</strong> Files and Directories</a></li><li><a href="07-file-attributes.html"><strong>2.4.</strong> File Attributes</a></li><li><a href="08-text-processing-part-1.html"><strong>2.5.</strong> Text Processing, Part 1</a></li><li><a href="09-text-processing-part-2.html"><strong>2.6.</strong> Text Processing, Part 2</a></li><li><a href="10-text-editors.html"><strong>2.7.</strong> Text Editors</a></li><li><a href="11-revisiting-paths.html"><strong>2.8.</strong> Revisiting Paths</a></li><li><a href="12-bash-scripting.html"><strong>2.9.</strong> Bash Scripting</a></li><li><a href="13-regular-expressions.html"><strong>2.10.</strong> Regular Expressions</a></li></ul></li><li><a href="p3-using-gcloud.html"><strong>3.</strong> Using Google Cloud (gcloud)</a></li><li><ul class="section"><li><a href="14-using-gcloud.html"><strong>3.1.</strong> Using gcloud for Virtual Machines</a></li><li><a href="15-expanding-storage.html"><strong>3.2.</strong> Expanding Storage</a></li></ul></li><li><a href="p4-managing-the-system.html"><strong>4.</strong> Managing the System</a></li><li><ul class="section"><li><a href="16-managing-users-groups.html"><strong>4.1.</strong> Managing Users and Groups</a></li><li><a href="17-systemd.html"><strong>4.2.</strong> systemd</a></li><li><a href="18-using-apt.html"><strong>4.3.</strong> Using APT to Manage Software</a></li></ul></li><li><a href="p5-networking-security.html"><strong>5.</strong> Networking and Security</a></li><li><ul class="section"><li><a href="19-tcip-networking.html"><strong>5.1.</strong> TCIP Networking</a></li><li><a href="20-networking-dns-domains.html"><strong>5.2.</strong> DNS and Domain Names</a></li><li><a href="21-security-chroot.html"><strong>5.3.</strong> Security and chroot</a></li><li><a href="22-security-firewall.html" class="active"><strong>5.4.</strong> Security and Firewalls</a></li><li><a href="23-backups.html"><strong>5.5.</strong> Backups</a></li></ul></li><li><a href="p6-lamp.html"><strong>6.</strong> Creating a LAMP Server</a></li><li><ul class="section"><li><a href="24-httpd-apache.html"><strong>6.1.</strong> Apache2 Web Server</a></li><li><a href="25-httpd-php.html"><strong>6.2.</strong> Apache2 and PHP</a></li><li><a href="26-httpd-virtualhosts.html"><strong>6.3.</strong> Apache2 and Virtual Hosts</a></li><li><a href="27-httpd-mariadb.html"><strong>6.4.</strong> Apache2 and MariaDB</a></li></ul></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page" tabindex="-1">
                
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars" title="Toggle sidebar"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush" title="Change theme"></i>
                    </div>

                    <h1 class="menu-title">Linux Systems Administration</h1>

                    <div class="right-buttons">
                        <a href="print.html">
                            <i id="print-button" class="fa fa-print" title="Print this book"></i>
                        </a>
                    </div>
                </div>

                <div id="content" class="content">
                    <a class="header" href="22-security-firewall.html#security-firewalls-iptables-and-firewall-cmd" id="security-firewalls-iptables-and-firewall-cmd"><h1>Security: Firewalls <code>iptables</code> and <code>firewall-cmd</code></h1></a>
<p>Netfilter is a part of the kernel that includes a suite of applications
that help manage how packets flow in and out of a server or internet
connected device. <code>iptables</code> is the command line user interface to
<strong>netfilter</strong> and is one of the main firewall applications on many
Linux distributions.</p>
<p>Fedora/RedHat offers a more user friendly interface to <code>iptables</code>
called <code>firewall-cmd</code> that I'll discuss below. Ubuntu offers its own
user friendly interface called <code>ufw</code>. In this lecture, I'll discuss
<code>iptables</code> and <code>firewall-cmd</code>.</p>
<a class="header" href="22-security-firewall.html#iptables" id="iptables"><h2>iptables</h2></a>
<p>There are five predefined tables (<em>operations</em>) and five chains that
come with <code>iptables</code>. Tables define the kinds of operations that you
use to control the firewall and the packets that come in and out of the
system or through a system. The <em>filter</em> and <em>nat</em> tables are the most
commonly used ones.</p>
<p>The five <em>chains</em> are lists of rules that act on packets flowing through
the system. Finally, there are also <em>targets</em>. These are the actions to
be performed on packets. The main targets include <strong>ACCEPT</strong>, <strong>DROP</strong>,
and <strong>RETURN</strong>.</p>
<p>From <code>man iptables</code>, the tables and respective chains include:</p>
<ul>
<li>filter (the default table)
<ul>
<li>INPUT: for packets destined to local sockets</li>
<li>FORWARD: for packets being routed through the box</li>
<li>OUTPUT: for locally-generated packets</li>
</ul>
</li>
<li>nat
<ul>
<li>PREROUTING: for altering packets as soon as they come in</li>
<li>INPUT: for altering packets destined for local sockets</li>
<li>OUTPUT: for altering locally-generated packets</li>
<li>POSTROUTING: for altering packets as they are about to go out</li>
</ul>
</li>
<li>mangle
<ul>
<li>PREROUTING</li>
<li>OUTPUT</li>
<li>INPUT</li>
<li>FORWARD</li>
<li>POSTROUTING</li>
</ul>
</li>
<li>raw
<ul>
<li>PREROUTING</li>
<li>OUTPUT</li>
</ul>
</li>
<li>security
<ul>
<li>INPUT</li>
<li>OUTPUT</li>
<li>FORWARD</li>
</ul>
</li>
</ul>
<p>We'll cover the filter tables and the nat tables.</p>
<a class="header" href="22-security-firewall.html#usage" id="usage"><h3>Usage</h3></a>
<p>First, we'll look at the default parameters for the <em>filter</em> table. You
need to be root to run this commands, or use <code>sudo</code>:</p>
<pre><code>sudo su
# -L: List all rules in the selected chain;
# if no chain is selected, then list all chains; and,
# -v: be verbose
iptables -L -v | less
iptables -L | grep policy
# specify a table
iptables -t filter -L -v
</code></pre>
<a class="header" href="22-security-firewall.html#allow-connections-only-from-subnet" id="allow-connections-only-from-subnet"><h3>Allow connections only from subnet</h3></a>
<p>We can change the firewall to only allow communication on a subnet. Of
course, in order to do this, we need the subnet <strong>Network ID</strong> and the
<strong>CIDR</strong> number:</p>
<pre><code>ip a
</code></pre>
<p>Now that we have the Network ID and the CIDR number, we can set the
firewall (don't follow along here if you're connecting via SSH because
this will end your connection):</p>
<pre><code># comment: first, set policy to drop all incoming, forwarding, and
# outgoing
# packets; this means we're starting from a baseline
iptables --policy INPUT DROP
iptables --policy FORWARD DROP
iptables --policy OUTPUT DROP

# comment: review new policies for the above chains
iptables -L | grep policy

# comment: now accept only input, forwarding, and output from the
# following
# comment: network ranges:

iptables -A INPUT -s 10.163.36.0/24 -j ACCEPT
iptables -A FORWARD -s 10.163.36.0/24 -j ACCEPT
iptables -A OUTPUT -s 10.163.36.0/24 -j ACCEPT
</code></pre>
<p>To test this, we can try to connect to a remote server:</p>
<pre><code>w3m https://www.google.com
</code></pre>
<p>There are lots of examples on the web. Examples from:</p>
<ul>
<li><a href="http://www.tecmint.com/linux-iptables-firewall-rules-examples-commands/">http://www.tecmint.com/linux-iptables-firewall-rules-examples-commands/</a></li>
<li><a href="https://www.howtogeek.com/177621/the-beginners-guide-to-iptables-the-linux-firewall/">https://www.howtogeek.com/177621/the-beginners-guide-to-iptables-the-linux-firewall/</a></li>
</ul>
<a class="header" href="22-security-firewall.html#prerouting" id="prerouting"><h3>PREROUTING</h3></a>
<p>Here is an example where we forward all traffic to port 25 to port 2525.
Here we use the <strong>NAT</strong> table, since NAT is responsible for network
address translation:</p>
<pre><code>iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 25 -j REDIRECT --to-port 2525
</code></pre>
<a class="header" href="22-security-firewall.html#output" id="output"><h3>OUTPUT</h3></a>
<p>Here is an example where we disable outgoing email by disabling the
ports that are commonly associated with email. Of course, this could
be bypassed by using non-standard ports for email, but for out case,
it's a decent demonstration:</p>
<pre><code>## iptables -A OUTPUT -p tcp --dports 25,465,587 -j REJECT
</code></pre>
<a class="header" href="22-security-firewall.html#firewall-cmd" id="firewall-cmd"><h2>firewall-cmd</h2></a>
<p><a href="https://docs.fedoraproject.org/en-US/Fedora/19/html/Security_Guide/sect-Security_Guide-Using_Firewalls.html">firewall-cmd documentation</a></p>
<p><strong>firewalld</strong> is a more user friendly interface to netfilters/iptables
in Red Hat based distros.</p>
<p>In <strong>firewalld</strong>, we use <strong>zones</strong> to manage internet traffic. It is
possible to define custom zones with <strong>firewalld</strong>, but it does come
included with the following predefined zones, and in many cases, these
might be all that we need:</p>
<ul>
<li>DROP : strictest. All incoming network packets are dropped</li>
<li>BLOCK : all very strict</li>
<li>PUBLIC : only selected incoming connections are accepted. Good zone
for web server, email server, etc.</li>
<li>EXTERNAL : external networks (useful for NAT)</li>
<li>DMZ : computers located in DMZ</li>
<li>work : trust most computers in network and accept some services</li>
<li>home : trust most computers in network and accept some services</li>
<li>trusted : trust all machines in network</li>
</ul>
<p>Check if running:</p>
<pre><code>firewall-cmd --state
</code></pre>
<p>Get active zones and interfaces attached to them:</p>
<pre><code>firewall-cmd --get-zones
firewall-cmd --get-default-zone
firewall-cmd --get-active-zones
FedoraServer
  interfaces: enp0s3
</code></pre>
<p>Allow port 22, list ports, remove services by name, add services by name:</p>
<pre><code>firewall-cmd --zone=FedoraServer --add-port=22/tcp
firewall-cmd --zone=FedoraServer --list-ports
firewall-cmd --zone=FedoraServer --remove-service=ssh --permanent
firewall-cmd --zone=FedoraServer --add-service=smtp --permanent
firewall-cmd --reload
</code></pre>
<p>Go into panic mode (drop all incoming/outgoing packets):</p>
<pre><code>firewall-cmd --panic-on
firewall-cmd --panic-off
</code></pre>
<p>To change default zone:</p>
<pre><code>firewall-cmd --permanent --set-default-zone=public
</code></pre>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a rel="prev" href="21-security-chroot.html" class="mobile-nav-chapters previous" title="Previous chapter">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="23-backups.html" class="mobile-nav-chapters next" title="Next chapter">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="21-security-chroot.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="23-backups.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        

        

        

        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS script -->
        

    </body>
</html>
