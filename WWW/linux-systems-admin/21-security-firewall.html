<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Security and Firewalls - Linux Systems Administration</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="linux-sysadmin.html"><strong aria-hidden="true">1.</strong> Linux Systems Administration</a></li><li class="chapter-item expanded "><a href="p1-system-basics.html"><strong aria-hidden="true">2.</strong> System Basics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="01-history-linux-unix.html"><strong aria-hidden="true">2.1.</strong> History of Unix and Linux</a></li><li class="chapter-item expanded "><a href="02-quick-ssh-connect.html"><strong aria-hidden="true">2.2.</strong> Connect to a Remote Server</a></li><li class="chapter-item expanded "><a href="03-filesystem-file-management.html"><strong aria-hidden="true">2.3.</strong> Linux Filesystems and File Management</a></li><li class="chapter-item expanded "><a href="04-file-attributes.html"><strong aria-hidden="true">2.4.</strong> File Attributes</a></li><li class="chapter-item expanded "><a href="05-text-processing-part-1.html"><strong aria-hidden="true">2.5.</strong> Text Processing, Part 1</a></li><li class="chapter-item expanded "><a href="06-text-processing-part-2.html"><strong aria-hidden="true">2.6.</strong> Text Processing, Part 2</a></li><li class="chapter-item expanded "><a href="07-text-editors.html"><strong aria-hidden="true">2.7.</strong> Text Editors</a></li><li class="chapter-item expanded "><a href="08-revisiting-paths.html"><strong aria-hidden="true">2.8.</strong> Revisiting Paths</a></li><li class="chapter-item expanded "><a href="09-bash-scripting.html"><strong aria-hidden="true">2.9.</strong> Bash Scripting</a></li><li class="chapter-item expanded "><a href="10-regular-expressions.html"><strong aria-hidden="true">2.10.</strong> Regular Expressions</a></li></ol></li><li class="chapter-item expanded "><a href="p2-managing-services-software.html"><strong aria-hidden="true">3.</strong> Managing Services and Software</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="11-installing-linux.html"><strong aria-hidden="true">3.1.</strong> Installing Linux in VirtualBox</a></li><li class="chapter-item expanded "><a href="12-logical-volumes.html"><strong aria-hidden="true">3.2.</strong> Logical Volume Management</a></li><li class="chapter-item expanded "><a href="13-virtualbox-nat.html"><strong aria-hidden="true">3.3.</strong> Using NAT in VirtualBox</a></li><li class="chapter-item expanded "><a href="14-webconsole-nat.html"><strong aria-hidden="true">3.4.</strong> NAT Table in VirtualBox</a></li><li class="chapter-item expanded "><a href="15-managing-users-groups.html"><strong aria-hidden="true">3.5.</strong> Managing Users and Groups</a></li><li class="chapter-item expanded "><a href="16-systemd.html"><strong aria-hidden="true">3.6.</strong> systemd</a></li><li class="chapter-item expanded "><a href="17-backup-and-using-dnf.html"><strong aria-hidden="true">3.7.</strong> Backups and DNF</a></li></ol></li><li class="chapter-item expanded "><a href="p3-networking-security.html"><strong aria-hidden="true">4.</strong> Networking and Security</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="18-tcip-networking.html"><strong aria-hidden="true">4.1.</strong> TCIP Networking</a></li><li class="chapter-item expanded "><a href="19-networking-dns-domains.html"><strong aria-hidden="true">4.2.</strong> DNS and Domain Names</a></li><li class="chapter-item expanded "><a href="20-security-chroot.html"><strong aria-hidden="true">4.3.</strong> Security and chroot</a></li><li class="chapter-item expanded "><a href="21-security-firewall.html" class="active"><strong aria-hidden="true">4.4.</strong> Security and Firewalls</a></li></ol></li><li class="chapter-item expanded "><a href="p4-lamp.html"><strong aria-hidden="true">5.</strong> Creating a LAMP Server</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="22-httpd-apache.html"><strong aria-hidden="true">5.1.</strong> Apache2 Web Server</a></li><li class="chapter-item expanded "><a href="23-httpd-php.html"><strong aria-hidden="true">5.2.</strong> Apache2 and PHP</a></li><li class="chapter-item expanded "><a href="24-httpd-virtualhosts.html"><strong aria-hidden="true">5.3.</strong> Apache2 and Virtual Hosts</a></li><li class="chapter-item expanded "><a href="25-httpd-mysql.html"><strong aria-hidden="true">5.4.</strong> Apache2 and MySQL</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Linux Systems Administration</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="security-firewalls-iptables-and-firewall-cmd"><a class="header" href="#security-firewalls-iptables-and-firewall-cmd">Security: Firewalls <code>iptables</code> and <code>firewall-cmd</code></a></h1>
<p>Netfilter is a part of the kernel that includes a suite of applications
that help manage how packets flow in and out of a server or internet
connected device. <code>iptables</code> is the command line user interface to
<strong>netfilter</strong> and is one of the main firewall applications on many
Linux distributions.</p>
<p>Fedora/RedHat offers a more user friendly interface to <code>iptables</code>
called <code>firewall-cmd</code> that I'll discuss below. Ubuntu offers its own
user friendly interface called <code>ufw</code>. In this lecture, I'll discuss
<code>iptables</code> and <code>firewall-cmd</code>.</p>
<h2 id="iptables"><a class="header" href="#iptables">iptables</a></h2>
<p>There are five predefined tables (<em>operations</em>) and five chains that
come with <code>iptables</code>. Tables define the kinds of operations that you
use to control the firewall and the packets that come in and out of the
system or through a system. The <em>filter</em> and <em>nat</em> tables are the most
commonly used ones.</p>
<p>The five <em>chains</em> are lists of rules that act on packets flowing through
the system. Finally, there are also <em>targets</em>. These are the actions to
be performed on packets. The main targets include <strong>ACCEPT</strong>, <strong>DROP</strong>,
and <strong>RETURN</strong>.</p>
<p>From <code>man iptables</code>, the tables and respective chains include:</p>
<ul>
<li>filter (the default table)
<ul>
<li>INPUT: for packets destined to local sockets</li>
<li>FORWARD: for packets being routed through the box</li>
<li>OUTPUT: for locally-generated packets</li>
</ul>
</li>
<li>nat
<ul>
<li>PREROUTING: for altering packets as soon as they come in</li>
<li>INPUT: for altering packets destined for local sockets</li>
<li>OUTPUT: for altering locally-generated packets</li>
<li>POSTROUTING: for altering packets as they are about to go out</li>
</ul>
</li>
<li>mangle
<ul>
<li>PREROUTING</li>
<li>OUTPUT</li>
<li>INPUT</li>
<li>FORWARD</li>
<li>POSTROUTING</li>
</ul>
</li>
<li>raw
<ul>
<li>PREROUTING</li>
<li>OUTPUT</li>
</ul>
</li>
<li>security
<ul>
<li>INPUT</li>
<li>OUTPUT</li>
<li>FORWARD</li>
</ul>
</li>
</ul>
<p>We'll cover the filter tables and the nat tables.</p>
<h3 id="usage"><a class="header" href="#usage">Usage</a></h3>
<p>First, we'll look at the default parameters for the <em>filter</em> table. You
need to be root to run this commands, or use <code>sudo</code>:</p>
<pre><code>sudo su
# -L: List all rules in the selected chain;
# if no chain is selected, then list all chains; and,
# -v: be verbose
iptables -L -v | less
iptables -L | grep policy
# specify a table
iptables -t filter -L -v
</code></pre>
<h3 id="allow-connections-only-from-subnet"><a class="header" href="#allow-connections-only-from-subnet">Allow connections only from subnet</a></h3>
<p>We can change the firewall to only allow communication on a subnet. Of
course, in order to do this, we need the subnet <strong>Network ID</strong> and the
<strong>CIDR</strong> number:</p>
<pre><code>ip a
</code></pre>
<p>Now that we have the Network ID and the CIDR number, we can set the
firewall (don't follow along here if you're connecting via SSH because
this will end your connection):</p>
<pre><code># comment: first, set policy to drop all incoming, forwarding, and
# outgoing
# packets; this means we're starting from a baseline
iptables --policy INPUT DROP
iptables --policy FORWARD DROP
iptables --policy OUTPUT DROP

# comment: review new policies for the above chains
iptables -L | grep policy

# comment: now accept only input, forwarding, and output from the
# following
# comment: network ranges:

iptables -A INPUT -s 10.163.36.0/24 -j ACCEPT
iptables -A FORWARD -s 10.163.36.0/24 -j ACCEPT
iptables -A OUTPUT -s 10.163.36.0/24 -j ACCEPT
</code></pre>
<p>To test this, we can try to connect to a remote server:</p>
<pre><code>w3m https://www.google.com
</code></pre>
<p>There are lots of examples on the web. Examples from:</p>
<ul>
<li><a href="http://www.tecmint.com/linux-iptables-firewall-rules-examples-commands/">http://www.tecmint.com/linux-iptables-firewall-rules-examples-commands/</a></li>
<li><a href="https://www.howtogeek.com/177621/the-beginners-guide-to-iptables-the-linux-firewall/">https://www.howtogeek.com/177621/the-beginners-guide-to-iptables-the-linux-firewall/</a></li>
</ul>
<h3 id="prerouting"><a class="header" href="#prerouting">PREROUTING</a></h3>
<p>Here is an example where we forward all traffic to port 25 to port 2525.
Here we use the <strong>NAT</strong> table, since NAT is responsible for network
address translation:</p>
<pre><code>iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 25 -j REDIRECT --to-port 2525
</code></pre>
<h3 id="output"><a class="header" href="#output">OUTPUT</a></h3>
<p>Here is an example where we disable outgoing email by disabling the
ports that are commonly associated with email. Of course, this could
be bypassed by using non-standard ports for email, but for out case,
it's a decent demonstration:</p>
<pre><code>## iptables -A OUTPUT -p tcp --dports 25,465,587 -j REJECT
</code></pre>
<h2 id="firewall-cmd"><a class="header" href="#firewall-cmd">firewall-cmd</a></h2>
<p><a href="https://docs.fedoraproject.org/en-US/Fedora/19/html/Security_Guide/sect-Security_Guide-Using_Firewalls.html">firewall-cmd documentation</a></p>
<p><strong>firewalld</strong> is a more user friendly interface to netfilters/iptables
in Red Hat based distros.</p>
<p>In <strong>firewalld</strong>, we use <strong>zones</strong> to manage internet traffic. It is
possible to define custom zones with <strong>firewalld</strong>, but it does come
included with the following predefined zones, and in many cases, these
might be all that we need:</p>
<ul>
<li>DROP : strictest. All incoming network packets are dropped</li>
<li>BLOCK : all very strict</li>
<li>PUBLIC : only selected incoming connections are accepted. Good zone
for web server, email server, etc.</li>
<li>EXTERNAL : external networks (useful for NAT)</li>
<li>DMZ : computers located in DMZ</li>
<li>work : trust most computers in network and accept some services</li>
<li>home : trust most computers in network and accept some services</li>
<li>trusted : trust all machines in network</li>
</ul>
<p>Check if running:</p>
<pre><code>firewall-cmd --state
</code></pre>
<p>Get active zones and interfaces attached to them:</p>
<pre><code>firewall-cmd --get-zones
firewall-cmd --get-default-zone
firewall-cmd --get-active-zones
FedoraServer
  interfaces: enp0s3
</code></pre>
<p>Allow port 22, list ports, remove services by name, add services by name:</p>
<pre><code>firewall-cmd --zone=FedoraServer --add-port=22/tcp
firewall-cmd --zone=FedoraServer --list-ports
firewall-cmd --zone=FedoraServer --remove-service=ssh --permanent
firewall-cmd --zone=FedoraServer --add-service=smtp --permanent
firewall-cmd --reload
</code></pre>
<p>Go into panic mode (drop all incoming/outgoing packets):</p>
<pre><code>firewall-cmd --panic-on
firewall-cmd --panic-off
</code></pre>
<p>To change default zone:</p>
<pre><code>firewall-cmd --permanent --set-default-zone=public
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="20-security-chroot.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="p4-lamp.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="20-security-chroot.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="p4-lamp.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
